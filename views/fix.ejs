<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>X·ª≠ L√Ω S·ª± C·ªë</title>
    <link rel="stylesheet" href="/styles.css">
    <style>
        .photo-upload-container {
            margin: 15px 0;
            padding: 20px;
            background: #fff;
            border-radius: 8px;
            border: 2px dashed #56ab2f;
        }
        .photo-upload-label {
            display: block;
            font-weight: 600;
            color: #333;
            margin-bottom: 10px;
        }
        .photo-input {
            display: block;
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 5px;
            cursor: pointer;
        }
        .photo-preview {
            margin-top: 15px;
            text-align: center;
        }
        .photo-preview img {
            max-width: 100%;
            max-height: 300px;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        .remove-photo-btn {
            margin-top: 10px;
            padding: 5px 15px;
            background: #dc3545;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
        }
        .remove-photo-btn:hover {
            background: #c82333;
        }
    </style>
</head>
<body>
    <div class="container">
        <a href="/" class="back-link">‚Üê Quay l·∫°i trang ch·ªß</a>
        
        <h1 style="color: white; text-align: center; margin-bottom: 40px;">X·ª≠ L√Ω S·ª± C·ªë</h1>
        
        <% if (tickets.length === 0) { %>
            <div class="form-container" style="text-align: center; padding: 60px 40px;">
                <p style="font-size: 1.2em; color: #666;">Kh√¥ng c√≥ ticket n√†o c·∫ßn x·ª≠ l√Ω</p>
                <a href="/send" class="btn btn-primary" style="margin-top: 20px;">T·∫°o Ticket M·ªõi</a>
            </div>
        <% } else { %>
            <% tickets.forEach(ticket => { %>
                <div class="ticket-card">
                    <div class="ticket-header">
                        <h2 style="color: #333; margin: 0;">Ticket #<%= ticket.id %></h2>
                        <div>
                            <span class="status-badge status-<%= ticket.status %>">
                                <%= ticket.status === 'open' ? 'Ch∆∞a x·ª≠ l√Ω' : ticket.status === 'in_progress' ? 'ƒêang x·ª≠ l√Ω' : 'Ho√†n th√†nh' %>
                            </span>
                        </div>
                    </div>

                    <div class="ticket-info">
                        <div class="info-item">
                            <span class="info-label">Khu v·ª±c</span>
                            <span class="info-value"><%= ticket.area %></span>
                        </div>
                        <div class="info-item">
                            <span class="info-label">Thi·∫øt b·ªã</span>
                            <span class="info-value"><%= ticket.equipment %></span>
                        </div>
                        <div class="info-item">
                            <span class="info-label">Lo·∫°i c√¥ng t√°c</span>
                            <span class="info-value"><%= ticket.work_type %></span>
                        </div>
                        <div class="info-item">
                            <span class="info-label">Th·ªùi ƒëi·ªÉm d·ª´ng</span>
                            <span class="info-value"><%= new Date(ticket.stop_time).toLocaleString('vi-VN') %></span>
                        </div>
                    </div>

                   
                    <% if (ticket.status !== 'finished') { %>
                        <div style="display: flex; gap: 10px; margin-bottom: 15px;">
                            <button onclick="updateStatus(<%= ticket.id %>, 'in_progress')" class="btn btn-info btn-sm">
                                ƒê√°nh d·∫•u ƒëang x·ª≠ l√Ω
                            </button>
                        </div>

                        <details open>
                            <summary style="cursor: pointer; font-weight: 600; color: #56ab2f; margin-bottom: 15px;">C·∫≠p nh·∫≠t th√¥ng tin s·ª≠a ch·ªØa</summary>
                            <form action="/fix/<%= ticket.id %>" method="POST" enctype="multipart/form-data" style="background: #f8f9fa; padding: 20px; border-radius: 8px; margin-top: 10px;">
                                <div class="form-group">
                                    <label for="completion_time_<%= ticket.id %>">Th·ªùi gian ho√†n th√†nh</label>
                                    <input type="datetime-local" id="completion_time_<%= ticket.id %>" name="completion_time" required>
                                </div>

                                <div class="form-group">
                                    <label for="cause_recognition_<%= ticket.id %>">Ghi nh·∫≠n nguy√™n nh√¢n</label>
                                    <textarea id="cause_recognition_<%= ticket.id %>" name="cause_recognition" placeholder="Ghi nh·∫≠n chi ti·∫øt nguy√™n nh√¢n" required></textarea>
                                </div>

                                <div class="form-group">
                                    <label for="solution_<%= ticket.id %>">H∆∞·ªõng x·ª≠ l√Ω kh·∫Øc ph·ª•c</label>
                                    <textarea id="solution_<%= ticket.id %>" name="solution" placeholder="M√¥ t·∫£ c√°ch kh·∫Øc ph·ª•c" required></textarea>
                                </div>

                                <div class="form-group">
                                    <label for="materials_used_<%= ticket.id %>">V·∫≠t t∆∞ s·ª≠ d·ª•ng (n·∫øu c√≥)</label>
                                    <textarea id="materials_used_<%= ticket.id %>" name="materials_used" placeholder="Li·ªát k√™ c√°c v·∫≠t t∆∞ ƒë√£ s·ª≠ d·ª•ng"></textarea>
                                </div>

                                <div class="form-group">
                                    <label for="total_processing_time_<%= ticket.id %>">Th·ªùi gian ch·ªù v·∫≠t t∆∞ (n·∫øu c√≥)</label>
                                    <input type="text" id="total_processing_time_<%= ticket.id %>" name="total_processing_time" placeholder="V√≠ d·ª•: 3 gi·ªù 6 ph√∫t" required>
                                </div>

                                <div class="form-group">
                                    <label for="equipment_status_after_<%= ticket.id %>">T√¨nh tr·∫°ng thi·∫øt b·ªã sau b·∫£o tr√¨</label>
                                    <textarea id="equipment_status_after_<%= ticket.id %>" name="equipment_status_after" placeholder="M√¥ t·∫£ t√¨nh tr·∫°ng sau khi s·ª≠a ch·ªØa" required></textarea>
                                </div>

                                <div class="form-group">
                                    <label for="recommendations_<%= ticket.id %>">ƒê·ªÅ ngh·ªã khuy·∫øn c√°o</label>
                                    <textarea id="recommendations_<%= ticket.id %>" name="recommendations" placeholder="C√°c khuy·∫øn c√°o ho·∫∑c ƒë·ªÅ xu·∫•t"></textarea>
                                </div>

                                <!-- Photo Upload Section -->
                                <div class="photo-upload-container">
                                    <label class="photo-upload-label">üì∏ H√¨nh ·∫£nh sau s·ª≠a ch·ªØa</label>
                                    <input type="file" 
                                           id="photo_after_<%= ticket.id %>" 
                                           name="photo_after" 
                                           class="photo-input"
                                           accept="image/*"
                                           onchange="previewPhoto(event, <%= ticket.id %>)">
                                    <div id="preview_<%= ticket.id %>" class="photo-preview" style="display: none;">
                                        <img id="preview_img_<%= ticket.id %>" src="" alt="Preview">
                                        <br>
                                        <button type="button" class="remove-photo-btn" onclick="removePhoto(<%= ticket.id %>)">
                                            X√≥a ·∫£nh
                                        </button>
                                    </div>
                                </div>

                                <button type="submit" class="btn btn-success">Ho√†n th√†nh v√† l∆∞u</button>
                            </form>
                        </details>
                    <% } else { %>
                        <div style="background: #d1e7dd; padding: 15px; border-radius: 8px; color: #0f5132; text-align: center;">
                            <strong>‚úì Ticket n√†y ƒë√£ ƒë∆∞·ª£c x·ª≠ l√Ω ho√†n th√†nh</strong>
                        </div>
                    <% } %>
                </div>
            <% }) %>
        <% } %>
    </div>

    <script>
        async function updateStatus(id, status) {
            try {
                const response = await fetch(`/update-status/${id}`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ status })
                });
                
                if (response.ok) {
                    alert('C·∫≠p nh·∫≠t tr·∫°ng th√°i th√†nh c√¥ng!');
                    location.reload();
                } else {
                    alert('C√≥ l·ªói x·∫£y ra khi c·∫≠p nh·∫≠t tr·∫°ng th√°i');
                }
            } catch (error) {
                alert('C√≥ l·ªói x·∫£y ra: ' + error.message);
            }
        }

        function previewPhoto(event, ticketId) {
            const file = event.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    const previewDiv = document.getElementById(`preview_${ticketId}`);
                    const previewImg = document.getElementById(`preview_img_${ticketId}`);
                    previewImg.src = e.target.result;
                    previewDiv.style.display = 'block';
                }
                reader.readAsDataURL(file);
            }
        }

        function removePhoto(ticketId) {
            const fileInput = document.getElementById(`photo_after_${ticketId}`);
            const previewDiv = document.getElementById(`preview_${ticketId}`);
            const previewImg = document.getElementById(`preview_img_${ticketId}`);
            
            fileInput.value = '';
            previewImg.src = '';
            previewDiv.style.display = 'none';
        }
    </script>
</body>
</html>